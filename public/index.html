<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spintar</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üé∞</text></svg>">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-auth-compat.js"></script>
    
    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
        async function loadFirebaseConfig() {
            try {
                console.log('üîê –ó–∞–≥—Ä—É–∂–∞–µ–º Firebase –∫–æ–Ω—Ñ–∏–≥ –∏–∑ env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö...');
                const response = await fetch('/api/firebase-config');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                console.log('‚úÖ Firebase –∫–æ–Ω—Ñ–∏–≥ –∑–∞–≥—Ä—É–∂–µ–Ω –±–µ–∑–æ–ø–∞—Å–Ω–æ');
                return data.firebaseConfig;
            } catch (error) {
                console.error('‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é!', error);
                console.error('‚ùå –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è FIREBASE_API_KEY –∏ FIREBASE_PROJECT_ID –≤ Vercel');
                throw new Error('Firebase configuration failed to load');
            }
        }
        
        // Async —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º –∫–æ–Ω—Ñ–∏–≥–æ–º
        async function initializeFirebaseSafely() {
            const firebaseConfig = await loadFirebaseConfig();
            
            // Initialize Firebase
            firebase.initializeApp(firebaseConfig);
            const firebaseDB = firebase.firestore();
            const firebaseAuth = firebase.auth();
            
            // Make Firebase available globally
            window.firebaseDB = firebaseDB;
            window.firebaseAuth = firebaseAuth;
            
            // Make Firebase compat functions available globally
            window.firebaseDoc = function(db, collection, docId) {
                return db.collection(collection).doc(docId);
            };
            window.firebaseGetDoc = function(db, collection, docId) {
                return db.collection(collection).doc(docId);
            };
            window.firebaseSetDoc = function(docRef, data) {
                return docRef.set(data);
            };
            window.firebaseOnSnapshot = function(docRef, callback) {
                return docRef.onSnapshot(callback);
            };
            window.firebaseCollection = function(db, collectionPath) {
                return db.collection(collectionPath);
            };
            
            console.log('üî• Firebase —É—Å–ø–µ—à–Ω–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω —Å –±–µ–∑–æ–ø–∞—Å–Ω—ã–º –∫–æ–Ω—Ñ–∏–≥–æ–º');
            return true;
        }
    </script>
    <style>
        :root {
            --bg-color: #e6d5c0;
            --container-bg: #f8efe4;
            --text-color: #2c3e50;
            --title-color: #b86f3d;
            --accent-color: #a65d27;
            --shadow-color: rgba(0, 0, 0, 0.15);
            --button-bg: #b86f3d;
            --button-hover: #a65d27;
            --button-disabled: #d4b5a0;
            --win-color: #27ae60;
            --loss-color: #c0392b;
            --bonus-color: #d4a017;
            --score-label-color: #6b4423;
        }

        [data-theme="dark"] {
            --bg-color: #2c3e50;
            --container-bg: #34495e;
            --text-color: #fff;
            --title-color: #f1c40f;
            --accent-color: #e67e22;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --button-bg: #e74c3c;
            --button-hover: #c0392b;
            --button-disabled: #bdc3c7;
            --score-label-color: #fff;
        }

        .theme-switch {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            background: var(--container-bg);
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            box-shadow: 0 2px 4px var(--shadow-color);
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
            margin-top: 10px;
            width: fit-content;
        }

        .theme-switch:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        .theme-icon {
            font-size: 20px;
        }

        body {
            margin: 0;
            background: var(--bg-color);
            font-family: Arial, sans-serif;
            color: var(--text-color);
            transition: all 0.3s ease;
            overflow-x: hidden;
            min-width: 320px;
        }

        .game-wrapper {
            width: 100%;
            display: none; /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å–∫—Ä—ã—Ç–∞, JavaScript –ø–æ–∫–∞–∂–µ—Ç –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ */
            justify-content: center;
        }

        .game-container {
            display: flex;
            gap: 15px;
            padding: 10px;
            box-sizing: border-box;
            align-items: flex-start;
            width: 100%;
            max-width: 1200px;
            overflow-x: hidden;
            min-width: 0;
        }

        .slot-machine-container {
            flex: 0 0 320px;
            min-height: 300px;
            background: var(--container-bg);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px var(--shadow-color);
            color: var(--text-color);
            height: fit-content;
        }

        .history-container {
            flex: 0 0 200px;
            min-height: 333px;
        }

        .center-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            min-width: 0;
            max-width: 300px;
            align-items: center;
        }

        .slot-machine{width:100%;max-width:100%;background:transparent;padding:0;border-radius:0;box-shadow:none;text-align:center;margin-bottom:0;position:relative}.reels{display:flex;gap:10px;margin-bottom:20px;position:relative;justify-content:center;padding:10px}.reel{width:80px;height:180px;background:white;border-radius:5px;overflow:hidden;position:relative}.reel-strip{position:absolute;width:100%;left:0;top:0;display:flex;flex-direction:column;align-items:center}.emoji-symbol{width:80px;height:60px;display:flex;align-items:center;justify-content:center;font-size:40px;flex-shrink:0}

        .price-list{width:100%;max-width:100%;background:var(--container-bg);padding:10px;border-radius:8px;box-shadow:0 2px 5px var(--shadow-color);height:fit-content}.price-categories{display:flex;flex-wrap:wrap;gap:8px;justify-content:space-between}.price-category{flex:1;min-width:120px;text-align:center;padding:6px;border:1px solid var(--border-color);border-radius:6px;background:var(--bg-color)}.price-category h4{margin:0 0 5px 0;font-size:13px;color:var(--accent-color)}.price-category-title{font-size:14px;color:var(--title-color);margin-bottom:8px;font-weight:bold}.price-items{display:flex;flex-wrap:wrap;gap:4px;justify-content:center}.price-item{display:inline-flex;align-items:center;gap:3px;font-size:13px;background:var(--bg-color);padding:4px 7px;border-radius:4px;border:1px solid var(--border-color)}.price-item span{margin-right:5px}.price-item .points{color:#28a745;font-size:14px}

        .scores-table{flex:0 0 220px;min-height:300px}

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ */
        @keyframes spin {
            0% { transform: translateY(0); }
            100% { transform: translateY(-840px); }
        }

        .spinning {
            animation: spin 0.5s linear infinite;
        }

        .controls{margin:20px 0;display:flex;gap:10px;justify-content:center;align-items:flex-start}.bonus-group{display:flex;flex-direction:column;align-items:center}.bonus-timer{font-size:14px;color:#666;margin-top:5px;text-align:center}.spin-button,.bonus-button{padding:10px 20px;font-size:16px;border:none;border-radius:5px;cursor:pointer;transition:background-color 0.3s,transform 0.1s;background-color:var(--button-bg);color:white}.spin-button:hover,.bonus-button:hover{background-color:var(--button-hover)}.spin-button:disabled,.bonus-button:disabled{background-color:var(--button-disabled)}.spin-button:active,.bonus-button:active{transform:scale(0.98)}

        .score{font-size:24px;margin:20px 0;color:var(--score-label-color)}.score-value{color:var(--accent-color)}

        .scores-table {
            background: var(--container-bg);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px var(--shadow-color);
            color: var(--text-color);
        }

        .scores-table h2 {
            margin: 0 0 15px 0;
            text-align: center;
            color: var(--title-color);
            font-size: 20px;
        }

        .scores-category {
            background: var(--bg-color);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .scores-category:last-child {
            margin-bottom: 0;
        }

        .category-header {
            color: var(--accent-color);
            font-size: 16px;
            margin-bottom: 8px;
            text-align: center;
        }

        .total-score {
            font-size: 24px;
            text-align: center;
            color: var(--title-color);
            font-weight: bold;
        }

        .category-ips {
            font-size: 12px;
            text-align: center;
            color: #95a5a6;
            margin-top: 5px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ª–∏–Ω–∏–π –≤—ã–∏–≥—Ä—ã—à–∞ */
        #winLines {
            position: absolute;
            top: 10px;
            left: -15px;
            width: calc(100% + 5px);
            height: calc(100% - 20px);
            pointer-events: none;
            z-index: 10;
        }

        .win-line {
            stroke: #ffff00;
            stroke-width: 8;
            stroke-linecap: round;
            filter: drop-shadow(0 0 8px rgba(255, 255, 0, 1)) 
                   drop-shadow(0 0 12px rgba(255, 165, 0, 0.8));
            opacity: 1;
        }

        @keyframes drawLine {
            from {
                stroke-dashoffset: 1000;
                opacity: 0;
            }
            to {
                stroke-dashoffset: 0;
                opacity: 1;
            }
        }

        .win-line {
            stroke-dasharray: 1000;
            animation: drawLine 0.5s ease-out forwards;
        }

        .history-container {
            background: var(--container-bg);
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 5px var(--shadow-color);
            color: var(--text-color);
            height: fit-content;
            max-height: var(--price-list-height, fit-content);
            display: flex;
            flex-direction: column;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
        }

        .history-title {
            margin: 0 0 15px 0;
            text-align: center;
            color: var(--title-color);
            font-size: 20px;
        }

        .history-item {
            background: var(--bg-color);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            font-size: 14px;
            animation: slideIn 0.3s ease-out forwards;
            opacity: 0;
        }

        .history-item:last-child {
            margin-bottom: 0;
        }

        .history-item.win {
            border-left: 3px solid var(--win-color);
        }

        .history-item.loss {
            border-left: 3px solid var(--loss-color);
        }

        .history-item.bonus {
            border-left: 3px solid var(--bonus-color);
        }

        .history-item.penalty {
            border-left: 3px solid #dc3545;
        }

        .history-time {
            color: #95a5a6;
            font-size: 12px;
            margin-top: 4px;
            display: block;
        }

        /* –°—Ç–∏–ª–∏–∑–∞—Ü–∏—è —Å–∫—Ä–æ–ª–ª–±–∞—Ä–∞ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ */
        .history-list::-webkit-scrollbar {
            width: 8px;
        }

        .history-list::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }

        .history-list::-webkit-scrollbar-thumb {
            background: #95a5a6;
            border-radius: 4px;
        }

        .history-list::-webkit-scrollbar-thumb:hover {
            background: #7f8c8d;
        }

        /* –ê–Ω–∏–º–∞—Ü–∏—è –¥–ª—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∏—Å—Ç–æ—Ä–∏–∏ */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(30px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }


        /* –°—Ç–∏–ª–∏ –¥–ª—è —Ä–µ–π—Ç–∏–Ω–≥–∞ */
        .user-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .theme-switch {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            background: var(--border-color);
            color: var(--text-color);
            font-size: 12px;
            font-weight: 500;
            transition: background 0.3s ease;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding: 0 6px;
            margin: 0;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            font-size: 13px;
            transition: background-color 0.3s ease;
            line-height: 1;
            height: 16px;
            min-height: 16px;
        }

        .leaderboard-item:hover {
            background: rgba(184, 111, 61, 0.1);
        }

        .leaderboard-item:last-child {
            margin-bottom: 0;
        }

        .leaderboard-item .rank {
            font-size: 16px;
            font-weight: bold;
            min-width: 30px;
        }

        .leaderboard-item .username {
            flex: 0 1 100px;
            margin: 0 6px;
            font-weight: 500;
            color: var(--title-color);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .leaderboard-item .score {
            font-size: 14px;
            font-weight: bold;
            color: var(--accent-color);
            margin-left: auto;
        }

        .no-scores {
            text-align: center;
            color: #95a5a6;
            font-style: italic;
            padding: 20px;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥—Ä—É–∑–µ–π/–≤—Ä–∞–≥–æ–≤ */
        .relation-buttons {
            display: inline-flex;
            margin-right: 4px;
            gap: 2px;
        }
        
        .relation-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 13px;
            padding: 0;
            margin: 0;
            line-height: 1;
            opacity: 0.6;
            transition: opacity 0.2s ease, transform 0.1s ease;
        }
        
        .relation-btn:hover {
            opacity: 1;
            transform: scale(1.1);
        }
        
        .relation-btn.active {
            opacity: 1;
            background-color: rgba(0, 123, 255, 0.1);
            transform: scale(1.1);
        }

        .relation-btn:disabled {
            cursor: not-allowed;
            opacity: 0.3;
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —ç–º–æ–¥–∂–∏ —É –Ω–∏–∫–Ω–µ–π–º–æ–≤ */
        .user-emoji {
            font-size: 11px;
            margin-left: 3px;
            cursor: pointer;
            opacity: 0.7;
            position: relative;
        }

        .user-emoji:hover {
            opacity: 1;
        }

        /* Tooltip –¥–ª—è —ç–º–æ–¥–∂–∏ */
        .tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            white-space: nowrap;
            z-index: 1000;
            margin-bottom: 4px;
            pointer-events: none;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            border: 4px solid transparent;
            border-top-color: rgba(0, 0, 0, 0.8);
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è –ø–∞–Ω–µ–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ */
        .auth-panel {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 1000;
            background: var(--container-bg);
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 2px 5px var(--shadow-color);
            border: 2px solid var(--border-color);
            max-width: calc(100vw - 30px);
            box-sizing: border-box;
        }
        
        @media (max-width: 1200px) {
            .auth-panel {
                position: static !important;
                margin: 15px auto 20px auto;
                width: fit-content;
                max-width: 100%;
            }
        }

        .user-info, .login-panel {
            display: flex;
            align-items: center;
            gap: 10px;
        }


        .user-details {
            display: flex;
            flex-direction: column;
            min-width: 120px;
        }

        .user-name {
            font-weight: 600;
            color: var(--title-color);
            font-size: 14px;
        }

        .user-score, .guest-score {
            font-size: 12px;
            color: var(--accent-color);
            font-weight: 500;
        }

        .login-btn, .logout-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .login-btn {
            background: linear-gradient(135deg, #B86F3D, #D4853F);
            color: white;
        }

        .login-btn:hover {
            background: linear-gradient(135deg, #A0623A, #C07A3C);
            transform: translateY(-1px);
        }

        .logout-btn {
            background: var(--border-color);
            color: var(--text-color);
            font-size: 12px;
            padding: 6px 10px;
        }

        .logout-btn:hover {
            background: #e74c3c;
            color: white;
        }

        .guest-info {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 4px;
            margin-right: 10px;
        }

        .guest-info span {
            font-size: 13px;
            color: var(--text-color);
        }
        
        .debug-logout {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            z-index: 1001;
        }

        /* Media queries –¥–ª—è –∞–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç–∏ */
        @media (max-width: 1000px) {
            .game-container {
                flex-direction: column;
                gap: 10px;
                padding: 8px;
                margin: 0 auto;
            }
            
            /* –ü–æ—Ä—è–¥–æ–∫ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö: –±–∞—Ä–∞–±–∞–Ω—ã, –∏—Å—Ç–æ—Ä–∏—è, –ø—Ä–∞–π—Å-–ª–∏—Å—Ç, —Ä–µ–π—Ç–∏–Ω–≥ */
            .slot-machine-container {
                order: 1;
                flex: none;
                min-height: auto;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
                padding: 10px;
            }
            
            .center-column {
                order: 2;
                min-width: 0;
                max-width: 100%;
                align-items: stretch;
                width: 100%;
            }
            
            .price-list {
                order: 2;
                max-width: 100%;
                width: 100%;
                box-sizing: border-box;
            }
            
            .history-container {
                order: 1;
                flex: none;
                min-height: auto;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            .scores-table {
                order: 3;
                flex: none;
                min-height: auto;
                width: 100%;
                max-width: 100%;
                box-sizing: border-box;
            }
            
            .slot-machine {
                max-width: 100%;
                width: 100%;
                box-sizing: border-box;
            }
        }

        @media (max-width: 900px) {
            .game-container {
                padding: 5px;
                gap: 8px;
            }
            
            .history-container, .scores-table {
                min-height: 300px;
            }
            
            .price-categories {
                gap: 5px;
            }
            
            .price-category {
                min-width: 80px;
                padding: 4px;
            }
            
            .price-category h4 {
                font-size: 10px;
                margin-bottom: 3px;
            }
        }

        @media (max-width: 600px) {
            .game-container {
                padding: 5px;
                gap: 10px;
            }
            
            .price-categories {
                flex-direction: column;
                gap: 8px;
            }
            
            .price-category {
                min-width: auto;
                width: 100%;
                box-sizing: border-box;
            }
            
            .price-item {
                font-size: 11px;
                padding: 3px 5px;
                gap: 2px;
            }
            
            .price-category h4 {
                font-size: 12px;
                margin-bottom: 6px;
            }
            
            .reels {
                gap: 5px;
                padding: 5px;
            }
            
            .reel {
                width: 70px;
                height: 150px;
            }
            
            .emoji-symbol {
                width: 70px;
                height: 50px;
                font-size: 32px;
            }
            
            /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥—Ä—É–∑–µ–π/–≤—Ä–∞–≥–æ–≤ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            .relation-btn {
                font-size: 11px !important;
                width: 18px !important;
                height: 18px !important;
                padding: 0 !important;
            }
            
            .relation-buttons {
                gap: 2px !important;
            }
        }

        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
        @media (max-width: 400px) {
            .game-container {
                padding: 3px;
                gap: 8px;
            }
            
            .auth-panel {
                padding: 8px;
                font-size: 12px;
            }
            
            .user-details {
                min-width: 80px;
            }
            
            .login-btn {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .reels {
                gap: 3px;
                padding: 3px;
            }
            
            .reel {
                width: 60px;
                height: 120px;
            }
            
            .emoji-symbol {
                width: 60px;
                height: 40px;
                font-size: 28px;
            }
            
            .price-item {
                font-size: 10px;
                padding: 2px 4px;
            }
            
            .controls {
                flex-direction: column;
                gap: 8px;
            }
            
            .spin-button, .bonus-button {
                padding: 6px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <!-- –ë–ª–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div class="auth-panel" id="authPanel">
        <div class="user-info" id="userInfo" style="display: none;">
            <div class="user-details">
                <div class="user-name" id="userName">Guest</div>
                <div class="user-score" id="userScore">0 points</div>
            </div>
            <div class="user-actions">
                <button class="logout-btn" onclick="logout()">Logout</button>
                <div class="theme-switch" onclick="toggleTheme()">
                    <span class="theme-icon">‚òÄÔ∏è</span>
                    <span class="theme-text">Light</span>
                </div>
            </div>
        </div>
        <div class="login-panel" id="loginPanel">
            <div class="guest-info">
                <span>üë§ Playing as guest</span>
                <div class="guest-score" id="guestScore">0 points</div>
            </div>
            <button class="login-btn" onclick="login()">Login via Orbitar</button>
            <div class="theme-switch" onclick="toggleTheme()">
                <span class="theme-icon">‚òÄÔ∏è</span>
                <span class="theme-text">Light</span>
            </div>
        </div>
    </div>
    <div class="game-wrapper" id="gameWrapper">
        <div class="game-container">
        <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ë–∞—Ä–∞–±–∞–Ω—ã -->
        <div class="slot-machine-container">
            <div class="slot-machine">
                <div class="reels">
                    <div class="reel">
                        <div class="reel-strip"></div>
                    </div>
                    <div class="reel">
                        <div class="reel-strip"></div>
                    </div>
                    <div class="reel">
                        <div class="reel-strip"></div>
                    </div>
                    <svg id="winLines"></svg>
                </div>
                <div class="controls">
                    <button class="spin-button">Spin</button>
                    <div class="bonus-group">
                        <button class="bonus-button" id="bonusButton">Get Bonus</button>
                        <div class="bonus-timer" id="bonusTimer"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ò—Å—Ç–æ—Ä–∏—è + –ü—Ä–∞–π—Å-–ª–∏—Å—Ç -->
        <div class="center-column">
            <!-- –ò—Å—Ç–æ—Ä–∏—è –≤ —Ü–µ–Ω—Ç—Ä–∞–ª—å–Ω–æ–π –∫–æ–ª–æ–Ω–∫–µ -->
            <div class="history-container">
                <h2 class="history-title">History</h2>
                <div class="history-list" id="historyList"></div>
            </div>

            <!-- –ü—Ä–∞–π—Å-–ª–∏—Å—Ç –±–µ–∑ –∑–∞–≥–æ–ª–æ–≤–∫–∞ -->
            <div class="price-list">
                <div class="price-categories">
                    <div class="price-category">
                        <h4>Gaming (15)</h4>
                        <div class="price-items">
                            <div class="price-item"><span>üéÆ</span><span class="points">15</span></div>
                            <div class="price-item"><span>üé≤</span><span class="points">15</span></div>
                            <div class="price-item"><span>üéØ</span><span class="points">15</span></div>
                            <div class="price-item"><span>üé±</span><span class="points">15</span></div>
                            <div class="price-item"><span>üé≥</span><span class="points">15</span></div>
                        </div>
                    </div>
                    <div class="price-category">
                        <h4>Music (30)</h4>
                        <div class="price-items">
                            <div class="price-item"><span>üéº</span><span class="points">30</span></div>
                            <div class="price-item"><span>üéµ</span><span class="points">30</span></div>
                            <div class="price-item"><span>üé∏</span><span class="points">30</span></div>
                            <div class="price-item"><span>üé∫</span><span class="points">30</span></div>
                            <div class="price-item"><span>üé∑</span><span class="points">30</span></div>
                            <div class="price-item"><span>üéπ</span><span class="points">30</span></div>
                            <div class="price-item"><span>üéª</span><span class="points">30</span></div>
                        </div>
                    </div>
                    <div class="price-category">
                        <h4>Entertainment (45)</h4>
                        <div class="price-items">
                            <div class="price-item"><span>üé¨</span><span class="points">45</span></div>
                            <div class="price-item"><span>üé≠</span><span class="points">45</span></div>
                            <div class="price-item"><span>üé™</span><span class="points">45</span></div>
                            <div class="price-item"><span>üé®</span><span class="points">45</span></div>
                        </div>
                    </div>
                    <div class="price-category">
                        <h4>Nature (75)</h4>
                        <div class="price-items">
                            <div class="price-item"><span>üåü</span><span class="points">75</span></div>
                            <div class="price-item"><span>üí´</span><span class="points">75</span></div>
                            <div class="price-item"><span>‚≠ê</span><span class="points">75</span></div>
                            <div class="price-item"><span>üåô</span><span class="points">75</span></div>
                            <div class="price-item"><span>‚òÄÔ∏è</span><span class="points">75</span></div>
                            <div class="price-item"><span>üåà</span><span class="points">75</span></div>
                        </div>
                    </div>
                    <div class="price-category">
                        <h4>Luck (100-200)</h4>
                        <div class="price-items">
                            <div class="price-item"><span>üçÄ</span><span class="points">100</span></div>
                            <div class="price-item"><span>üéã</span><span class="points">100</span></div>
                            <div class="price-item"><span>üéç</span><span class="points">100</span></div>
                            <div class="price-item"><span>üé∞</span><span class="points">200</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: Highscores -->
        <div class="scores-table">
            <h2>üèÜ Highscores</h2>
            <div id="leaderboard">
                <div class="no-scores">No players yet</div>
            </div>
        </div>
    </div>


    <script>
        // Firebase references (–∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∞–ø—Ä—è–º—É—é)
        
        // –ò–≥—Ä–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let currentUser = null;
        let isLoggedIn = false;
        let playerScores = {};
        let isSpinning = false;
        let bonusButton, bonusTimer;
        let isUpdatingFromFirebase = false; // –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –∑–∞—Ü–∏–∫–ª–∏–≤–∞–Ω–∏—è
        let playerRelations = {}; // –•—Ä–∞–Ω–µ–Ω–∏–µ —Å–≤—è–∑–µ–π –¥—Ä—É–∑–µ–π/–≤—Ä–∞–≥–æ–≤
        


        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å OAuth2
        async function login() {
            try {
                // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                window.location.href = '/api/auth/login';
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ:', error);
                alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—Ö–æ–¥–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
            }
        }

        async function logout() {
            try {
                const response = await fetch('/api/auth/logout', {
                    method: 'POST',
                    credentials: 'include'
                });

                if (response.ok) {
                    currentUser = null;
                    isLoggedIn = false;
                    updateAuthUI();
                    console.log('‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—ã—Ö–æ–¥');
                } else {
                    throw new Error('Logout failed');
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ:', error);
                // –î–∞–∂–µ –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–µ –ø—Ä–æ—à–µ–ª, –æ—á–∏—â–∞–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
                currentUser = null;
                isLoggedIn = false;
                updateAuthUI();
            }
        }

        async function checkAuthStatus() {
            try {
                console.log('üîç [DEBUG] –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º /api/profile...');
                const response = await fetch('/api/profile', {
                    credentials: 'include'
                });
                console.log('üîç [DEBUG] Response status:', response.status);

                if (response.ok) {
                    const userData = await response.json();
                    currentUser = userData;
                    isLoggedIn = true;
                    console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω:', userData.username);
                    console.log('üîç [DEBUG] checkAuthStatus –∑–∞–≤–µ—Ä—à–µ–Ω —É—Å–ø–µ—à–Ω–æ');
                    
                    // –ê–≤—Ç–æ—Ä–∏–∑—É–µ–º—Å—è –≤ Firebase
                    await authenticateWithFirebase();
                } else if (response.status === 401) {
                    console.log('üîç [DEBUG] 401 - —Ç–æ–∫–µ–Ω –∏—Å—Ç–µ–∫, –ø—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å...');
                    
                    // –ü—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ refresh
                    const refreshResponse = await fetch('/api/auth/refresh', {
                        method: 'POST',
                        credentials: 'include'
                    });
                    
                    if (refreshResponse.ok) {
                        console.log('‚úÖ –¢–æ–∫–µ–Ω –æ–±–Ω–æ–≤–ª–µ–Ω, –ø–æ–≤—Ç–æ—Ä—è–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É...');
                        // –ü–æ–≤—Ç–æ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å —Å –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–º —Ç–æ–∫–µ–Ω–æ–º
                        const retryResponse = await fetch('/api/profile', {
                            credentials: 'include'
                        });
                        
                        if (retryResponse.ok) {
                            const userData = await retryResponse.json();
                            currentUser = userData;
                            isLoggedIn = true;
                            console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞:', userData.username);
                        } else {
                            console.log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞');
                            currentUser = null;
                            isLoggedIn = false;
                        }
                    } else {
                        console.log('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω');
                        currentUser = null;
                        isLoggedIn = false;
                    }
                } else {
                    console.log('‚ùå [DEBUG] –ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Å—Ç–∞—Ç—É—Å:', response.status);
                    currentUser = null;
                    isLoggedIn = false;
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
                currentUser = null;
                isLoggedIn = false;
            }

            console.log('üîÑ [DEBUG] –û–±–Ω–æ–≤–ª—è–µ–º UI...');
            updateAuthUI();
            console.log('‚úÖ [DEBUG] checkAuthStatus –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–≤–µ—Ä—à–µ–Ω');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ Firebase
        async function authenticateWithFirebase() {
            try {
                console.log('üîê [DEBUG] –ü–æ–ª—É—á–∞–µ–º Firebase —Ç–æ–∫–µ–Ω —Å —Å–µ—Ä–≤–µ—Ä–∞...');
                
                // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π
                const user = window.currentUser || {};
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (!user || !user.username) {
                    console.log('üîê [DEBUG] –ù–µ—Ç –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–æ—Å—Ç–µ–≤–æ–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä');
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ URL –∑–∞–ø—Ä–æ—Å–∞
                const username = user?.username || 'guest_' + Math.random().toString(36).substring(2, 10);
                const url = `/api/auth/firebase-token?username=${encodeURIComponent(username)}`;
                console.log(`üîê [DEBUG] –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ç–æ–∫–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${username}`);
                
                // –ü–æ–ª—É—á–∞–µ–º Firebase —Ç–æ–∫–µ–Ω —Å —Å–µ—Ä–≤–µ—Ä–∞
                const response = await fetch(url, {
                    credentials: 'include'
                });
                
                console.log('üîê [DEBUG] –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response.status, response.statusText);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå [DEBUG] –û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞:', errorText);
                    throw new Error(`–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è Firebase —Ç–æ–∫–µ–Ω–∞: ${response.status}`);
                }
                
                const responseData = await response.json();
                console.log('üîê [DEBUG] –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞ JSON:', responseData);
                
                // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å —Ç–æ–∫–µ–Ω –∏–∑ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞
                let firebaseToken = responseData.token;
                
                // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω–∞ –Ω–µ—Ç –≤ –æ—Ç–≤–µ—Ç–µ, –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ cookie
                if (!firebaseToken) {
                    console.log('üîê [DEBUG] –¢–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –æ—Ç–≤–µ—Ç–µ, –ø—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –∏–∑ cookie');
                    
                    const cookies = document.cookie.split(';').reduce((acc, cookie) => {
                        const [key, value] = cookie.trim().split('=');
                        acc[key] = value;
                        return acc;
                    }, {});
                    
                    console.log('üîê [DEBUG] –í—Å–µ cookies:', cookies);
                    
                    firebaseToken = cookies.firebase_token;
                }
                
                if (!firebaseToken) {
                    console.error('‚ùå [DEBUG] Firebase —Ç–æ–∫–µ–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∏ –≤ –æ—Ç–≤–µ—Ç–µ, –Ω–∏ –≤ cookies');
                    throw new Error('–ù–µ –Ω–∞–π–¥–µ–Ω Firebase —Ç–æ–∫–µ–Ω');
                }
                
                console.log('üîê [DEBUG] Firebase —Ç–æ–∫–µ–Ω –Ω–∞–π–¥–µ–Ω, –¥–ª–∏–Ω–∞:', firebaseToken.length);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ Firebase
                const currentUser = window.firebaseAuth.currentUser;
                console.log('üîê [DEBUG] –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Firebase:', currentUser);
                
                // –ê–≤—Ç–æ—Ä–∏–∑—É–µ–º—Å—è –≤ Firebase
                console.log('üîê [DEBUG] –ü—ã—Ç–∞–µ–º—Å—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –≤ Firebase...');
                await window.firebaseAuth.signInWithCustomToken(firebaseToken);
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                const userAfterAuth = window.firebaseAuth.currentUser;
                console.log('üîê [DEBUG] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', userAfterAuth);
                
                if (userAfterAuth) {
                    console.log('‚úÖ –£—Å–ø–µ—à–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤ Firebase, uid:', userAfterAuth.uid);
                    return true;
                } else {
                    console.error('‚ùå [DEBUG] –ü–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ Firebase:', error);
                return false;
            }
        }

        function updateAuthUI() {
            console.log('üîÑ [DEBUG] updateAuthUI –≤—ã–∑–≤–∞–Ω, isLoggedIn:', isLoggedIn);
            const userInfo = document.getElementById('userInfo');
            const loginPanel = document.getElementById('loginPanel');
            const userName = document.getElementById('userName');
            const userScore = document.getElementById('userScore');
            const gameWrapper = document.getElementById('gameWrapper');

            if (isLoggedIn && currentUser) {
                console.log('üîÑ [DEBUG] –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                
                try {
                    userInfo.style.display = 'block';
                    console.log('‚úÖ [DEBUG] userInfo –ø–æ–∫–∞–∑–∞–Ω');
                    
                    loginPanel.style.display = 'none';
                    console.log('‚úÖ [DEBUG] loginPanel —Å–∫—Ä—ã—Ç');
                    
                    gameWrapper.style.display = 'block';
                    console.log('‚úÖ [DEBUG] gameWrapper –ø–æ–∫–∞–∑–∞–Ω');
                    
                    userName.textContent = currentUser.username;
                    console.log('‚úÖ [DEBUG] username —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
                    
                    const userPoints = playerScores[currentUser.username] || 0;
                    userScore.textContent = `${userPoints} points`;
                    console.log('‚úÖ [DEBUG] –æ—á–∫–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã:', userPoints);
                    
                    console.log('üîÑ [DEBUG] UI –æ–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', currentUser.username);
                } catch (error) {
                    console.error('‚ùå [DEBUG] –û—à–∏–±–∫–∞ –≤ updateAuthUI:', error);
                }
            } else {
                console.log('üîÑ [DEBUG] –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                userInfo.style.display = 'none';
                loginPanel.style.display = 'flex';
                gameWrapper.style.display = 'none';
                console.log('‚úÖ [DEBUG] gameWrapper —Å–∫—Ä—ã—Ç');
            }
        }

        function getCurrentUsername() {
            if (isLoggedIn && currentUser) {
                return currentUser.username;
            } else {
                return null; // –ò–≥—Ä–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ—Ç–Ω–æ—à–µ–Ω–∏—è–º–∏ –¥—Ä—É–∑–µ–π/–≤—Ä–∞–≥–æ–≤
        async function savePlayerRelation(target, type, action) {
            try {
                console.log('üîÑ –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–Ω–æ—à–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –æ–±—â—É—é —Ñ—É–Ω–∫—Ü–∏—é —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', { target, type, action });
                
                if (!currentUser) {
                    throw new Error('User not logged in');
                }

                const username = currentUser.username;

                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Firebase
                await loadSavedScores();

                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
                if (!window.gameData) {
                    window.gameData = {};
                }
                if (!window.gameData.playerRelations) {
                    window.gameData.playerRelations = {};
                }
                if (!window.gameData.relationIndex) {
                    window.gameData.relationIndex = {};
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º playerRelations
                if (!window.gameData.playerRelations[username]) {
                    window.gameData.playerRelations[username] = {};
                }

                if (action === 'add') {
                    window.gameData.playerRelations[username][type] = target;
                    // –†–∞–∑—Ä–µ—à–∞–µ–º –∏–º–µ—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∏ –¥—Ä—É–≥–∞, –∏ –≤—Ä–∞–≥–∞
                    // –£–±—Ä–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ–≥–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—è
                } else {
                    delete window.gameData.playerRelations[username][type];
                }

                // –û–±–Ω–æ–≤–ª—è–µ–º relationIndex
                if (!window.gameData.relationIndex[target]) {
                    window.gameData.relationIndex[target] = {};
                }

                if (action === 'add') {
                    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–æ–≤—ã–π —Ç–∏–ø
                    if (!window.gameData.relationIndex[target][`${type}edBy`]) {
                        window.gameData.relationIndex[target][`${type}edBy`] = [];
                    }
                    if (!window.gameData.relationIndex[target][`${type}edBy`].includes(username)) {
                        window.gameData.relationIndex[target][`${type}edBy`].push(username);
                    }

                    // –†–∞–∑—Ä–µ—à–∞–µ–º –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –±—ã—Ç—å –≤ –¥—Ä—É–∑—å—è—Ö –∏ –≤—Ä–∞–≥–∞—Ö
                    // –£–±—Ä–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∏–∑ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ–≥–æ —Ç–∏–ø–∞
                } else {
                    // –£–±–∏—Ä–∞–µ–º –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Ç–∏–ø–∞
                    if (window.gameData.relationIndex[target][`${type}edBy`]) {
                        window.gameData.relationIndex[target][`${type}edBy`] = 
                            window.gameData.relationIndex[target][`${type}edBy`].filter(u => u !== username);
                        if (window.gameData.relationIndex[target][`${type}edBy`].length === 0) {
                            delete window.gameData.relationIndex[target][`${type}edBy`];
                        }
                    }
                }

                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Å–∏—Å—Ç–µ–º—É
                await saveScoresWithRelations();

                console.log('‚úÖ –û—Ç–Ω–æ—à–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ:', { target, type, action });
                return { success: true, message: `${action === 'add' ? 'Added' : 'Removed'} ${target} as ${type}` };

            } catch (error) {
                console.log('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç–Ω–æ—à–µ–Ω–∏—è:', error);
                throw error;
            }
        }

        async function loadPlayerRelations() {
            try {
                if (!currentUser) {
                    playerRelations = {};
                    return;
                }

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ –æ–±—â–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏–≥—Ä—ã
                await loadSavedScores();
                
                const username = currentUser.username;
                if (window.gameData?.playerRelations?.[username]) {
                    playerRelations = window.gameData.playerRelations[username];
                } else {
                    playerRelations = {};
                }
                console.log('‚úÖ –û—Ç–Ω–æ—à–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', playerRelations);
            } catch (error) {
                console.log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–Ω–æ—à–µ–Ω–∏–π:', error);
                playerRelations = {};
            }
        }

        async function loadWhoAddedMe() {
            try {
                if (!currentUser) return { friendedBy: [], enemiedBy: [] };

                // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑ –æ–±—â–µ–≥–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –∏–≥—Ä—ã
                await loadSavedScores();
                
                const username = currentUser.username;
                if (window.gameData?.relationIndex?.[username]) {
                    const relationIndex = window.gameData.relationIndex[username];
                    return {
                        friendedBy: relationIndex.friendedBy || [],
                        enemiedBy: relationIndex.enemiedBy || []
                    };
                }
                
                return { friendedBy: [], enemiedBy: [] };
            } catch (error) {
                console.log('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ –∫—Ç–æ –¥–æ–±–∞–≤–∏–ª:', error);
                return { friendedBy: [], enemiedBy: [] };
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–æ–Ω—É—Å–æ–≤/—à—Ç—Ä–∞—Ñ–æ–≤ –¥–ª—è –¥—Ä—É–∑–µ–π/–≤—Ä–∞–≥–æ–≤
        async function processFriendEnemyBonuses(winnerUsername, netWin) {
            if (!winnerUsername || !playerRelations) return { friendBonus: null, enemyPenalty: null };
            
            const bonusAmount = Math.floor(netWin * 0.1); // 10% –æ—Ç —á–∏—Å—Ç–æ–≥–æ –≤—ã–∏–≥—Ä—ã—à–∞ (–∑–∞ –≤—ã—á–µ—Ç–æ–º —Å—Ç–∞–≤–∫–∏)
            if (bonusAmount <= 0) return { friendBonus: null, enemyPenalty: null };
            
            const result = { friendBonus: null, enemyPenalty: null };
            
            try {
                // –ù–∞—á–∏—Å–ª—è–µ–º –±–æ–Ω—É—Å –¥—Ä—É–≥—É
                if (playerRelations.friend) {
                    const friendName = playerRelations.friend;
                    console.log(`üíù –ù–∞—á–∏—Å–ª—è–µ–º +${bonusAmount} –¥—Ä—É–≥—É ${friendName}`);
                    await updatePlayerScore(friendName, bonusAmount);
                    result.friendBonus = { name: friendName, amount: bonusAmount };
                }
                
                // –°–ø–∏—Å—ã–≤–∞–µ–º —à—Ç—Ä–∞—Ñ —Å –≤—Ä–∞–≥–∞  
                if (playerRelations.enemy) {
                    const enemyName = playerRelations.enemy;
                    console.log(`üí© –°–ø–∏—Å—ã–≤–∞–µ–º -${bonusAmount} —Å –≤—Ä–∞–≥–∞ ${enemyName}`);
                    await updatePlayerScore(enemyName, -bonusAmount);
                    result.enemyPenalty = { name: enemyName, amount: bonusAmount };
                }
            } catch (error) {
                console.log('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –±–æ–Ω—É—Å–æ–≤ –¥—Ä—É–∑–µ–π/–≤—Ä–∞–≥–æ–≤:', error);
            }
            
            return result;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã URL –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        function checkURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const authStatus = urlParams.get('auth');
            const error = urlParams.get('error');

            if (authStatus === 'success') {
                console.log('üéâ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!');
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', error);
                let errorMessage = '–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏';
                switch (error) {
                    case 'access_denied':
                        errorMessage = '–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω. –í—ã –æ—Ç–∫–ª–æ–Ω–∏–ª–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é.';
                        break;
                    case 'invalid_request':
                        errorMessage = '–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.';
                        break;
                    case 'state_mismatch':
                        errorMessage = '–û—à–∏–±–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.';
                        break;
                    case 'server_config':
                        errorMessage = '–û—à–∏–±–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–∞.';
                        break;
                    default:
                        errorMessage = `–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: ${error}`;
                }
                alert(errorMessage);
                // –û—á–∏—â–∞–µ–º URL –æ—Ç –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∏—Å—Ç–æ—Ä–∏–µ–π
        function addHistoryItem(type, message) {
            const historyList = document.getElementById('historyList');
            const item = document.createElement('div');
            item.className = `history-item ${type}`;
            item.style.opacity = '0'; // –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
            
            const time = new Date();
            const timeStr = time.toLocaleTimeString();
            
            // üîí –ë–ï–ó–û–ü–ê–°–ù–û–ï —Å–æ–∑–¥–∞–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –±–µ–∑ innerHTML
            const messageSpan = createSafeElement('span', '', message); // textContent —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
            const timeSpan = createSafeElement('span', 'history-time', timeStr);
            
            item.appendChild(messageSpan);
            item.appendChild(timeSpan);
            
            // –î–æ–±–∞–≤–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –≤ –Ω–∞—á–∞–ª–æ —Å–ø–∏—Å–∫–∞
            if (historyList.firstChild) {
                historyList.insertBefore(item, historyList.firstChild);
            } else {
                historyList.appendChild(item);
            }
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –≤ —Å–ª–µ–¥—É—é—â–µ–º –∫–∞–¥—Ä–µ
            requestAnimationFrame(() => {
                item.style.opacity = '1';
            });
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ Firebase Firestore
        async function loadSavedScores() {
            try {
                console.log('üî• Firebase: –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–≥—Ä—ã...');
                const gameDocRef = window.firebaseDB.collection('scores').doc('game_data');
                const docSnap = await gameDocRef.get();
                
                if (docSnap.exists) {
                    const data = docSnap.data();
                    console.log('‚úÖ Firebase: –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã!', data);
                    
                    playerScores = data.playerScores || {};
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
                    window.gameData = {
                        playerScores: data.playerScores || {},
                        playerRelations: data.playerRelations || {},
                        relationIndex: data.relationIndex || {}
                    };
                    
                    updateScoreDisplay('firebase');
                } else {
                    console.log('üìù Firebase: –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –∏–≥—Ä—ã');
                    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
                    window.gameData = {
                        playerScores: {},
                        playerRelations: {},
                        relationIndex: {}
                    };
                    // –°–æ–∑–¥–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç
                    await saveScores();
                    updateScoreDisplay('firebase');
                }
            } catch (error) {
                console.log('‚ùå Firebase –æ—à–∏–±–∫–∞:', error.message);
                
                // –ï—Å–ª–∏ –æ—à–∏–±–∫–∞ —Å–≤—è–∑–∞–Ω–∞ —Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–µ–π, –ø—ã—Ç–∞–µ–º—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Ç–æ–∫–µ–Ω
                if (error.code === 'permission-denied' || error.code === 'unauthenticated') {
                    console.log('üîÑ –ü–æ–ø—ã—Ç–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞ –¥–ª—è Firebase...');
                    await checkAuthStatus();
                    
                    if (isLoggedIn) {
                        console.log('üîÑ –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö Firebase...');
                        try {
                            const retryDocSnap = await window.firebaseGetDoc(gameDocRef);
                            if (retryDocSnap.exists) {
                                const data = retryDocSnap.data();
                                console.log('‚úÖ Firebase: –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–∞!', data);
                                
                                playerScores = data.playerScores || {};
                                window.gameData = {
                                    playerScores: data.playerScores || {},
                                    playerRelations: data.playerRelations || {},
                                    relationIndex: data.relationIndex || {}
                                };
                                updateScoreDisplay('firebase');
                                return;
                            }
                        } catch (retryError) {
                            console.log('‚ùå –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —Ç–∞–∫–∂–µ –Ω–µ—É–¥–∞—á–Ω–∞:', retryError.message);
                        }
                    }
                }
                
                // –ü—Ä–∏ –æ—à–∏–±–∫–µ Firebase –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É
                showFirebaseError('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firebase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
            }
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Firebase Firestore (–≤–∫–ª—é—á–∞—è –æ—Ç–Ω–æ—à–µ–Ω–∏—è)
        async function saveScoresWithRelations() {
            try {
                const gameDocRef = window.firebaseDoc(window.firebaseDB, 'scores', 'game_data');
                const gameData = {
                    playerScores: playerScores,
                    playerRelations: window.gameData?.playerRelations || {},
                    relationIndex: window.gameData?.relationIndex || {},
                    lastUpdated: new Date().toISOString()
                };
                
                await window.firebaseSetDoc(gameDocRef, gameData);
                console.log('üíæ Firebase: –î–∞–Ω–Ω—ã–µ —Å –æ—Ç–Ω–æ—à–µ–Ω–∏—è–º–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
            } catch (error) {
                console.error('‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê Firebase:', error.message);
                showFirebaseError('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ Firebase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
                throw error;
            }
        }

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Firebase Firestore
        async function saveScores() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏–¥–µ—Ç –ª–∏ —Å–µ–π—á–∞—Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ Firebase
            if (isUpdatingFromFirebase) {
                console.log('‚ö†Ô∏è [SAVE] –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ, —Ç–∞–∫ –∫–∞–∫ –∏–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ Firebase');
                return false;
            }
            
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ Firebase
                const currentFirebaseUser = window.firebaseAuth.currentUser;
                console.log('üîê [SAVE] –¢–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Firebase:', currentFirebaseUser ? currentFirebaseUser.uid : '–Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                
                if (!currentFirebaseUser) {
                    console.log('üîê [SAVE] –ü–æ–ø—ã—Ç–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤ Firebase...');
                    try {
                        await authenticateWithFirebase();
                        console.log('üîê [SAVE] –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å...');
                        const userAfterAuth = window.firebaseAuth.currentUser;
                        console.log('üîê [SAVE] –°—Ç–∞—Ç—É—Å –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', userAfterAuth ? userAfterAuth.uid : '–Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                    } catch (authError) {
                        console.error('‚ùå [SAVE] –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏:', authError);
                    }
                }
                
                const gameDocRef = window.firebaseDoc(window.firebaseDB, 'scores', 'game_data');
                const gameData = {
                    playerScores: playerScores,
                    playerRelations: window.gameData?.playerRelations || {},
                    relationIndex: window.gameData?.relationIndex || {},
                    lastUpdated: new Date().toISOString()
                };
                
                console.log('üíæ [SAVE] –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase:', Object.keys(playerScores));
                await window.firebaseSetDoc(gameDocRef, gameData);
                console.log('‚úÖ [SAVE] ‚úì –ö–†–û–°–°-–£–°–¢–†–û–ô–°–¢–í–û –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø: –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ Firebase!');
                return true; // –£—Å–ø–µ—à–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            } catch (error) {
                console.error('‚ùå [SAVE] –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê Firebase:', error.message);
                showFirebaseError('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö. –ò–≥—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ —Å Firebase.');
                return false; // –ù–µ—É—Å–ø–µ—à–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
            }
        }

        // üîí –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ó–ê–©–ò–¢–´ –û–¢ XSS - —ç–∫—Ä–∞–Ω–∏—Ä—É–µ—Ç HTML —Å–∏–º–≤–æ–ª—ã
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // üîí –ë–ï–ó–û–ü–ê–°–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è HTML —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å —Ç–µ–∫—Å—Ç–æ–º
        function createSafeElement(tagName, className, textContent) {
            const element = document.createElement(tagName);
            if (className) element.className = className;
            if (textContent) element.textContent = textContent; // textContent –±–µ–∑–æ–ø–∞—Å–µ–Ω!
            return element;
        }

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ—à–∏–±–∫—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firebase
        function showFirebaseError(message) {
            console.error('üî• Firebase Error:', message);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ—à–∏–±–∫—É
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                position: fixed; top: 20px; left: 50%; transform: translateX(-50%); 
                background: #ff6b6b; color: white; padding: 15px 20px; 
                border-radius: 8px; z-index: 9999; box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                font-family: Arial, sans-serif; font-weight: bold;
            `;
            errorDiv.textContent = message;
            document.body.appendChild(errorDiv);
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∏–≥—Ä—É
            const spinButton = document.querySelector('.spin-button');
            if (spinButton) {
                spinButton.disabled = true;
                spinButton.textContent = '–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º';
            }
            
            // –£–±–∏—Ä–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                if (document.body.contains(errorDiv)) {
                    document.body.removeChild(errorDiv);
                }
            }, 10000);
        }

        // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
        function subscribeToScores() {
            try {
                const gameDocRef = window.firebaseDoc(window.firebaseDB, 'scores', 'game_data');
                
                window.firebaseOnSnapshot(gameDocRef, (doc) => {
                    if (doc.exists) {
                        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥, —á—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º—Å—è –∏–∑ Firebase
                        isUpdatingFromFirebase = true;
                        
                        const data = doc.data();
                        console.log(' [SYNC] –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∏–∑ Firebase:', Object.keys(data.playerScores || {}));
                        
                        // –£–ú–ù–û–ï –°–õ–ò–Ø–ù–ò–ï: Firebase –¥–∞–Ω–Ω—ã–µ –∏–º–µ—é—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç, –Ω–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –µ—Å–ª–∏ –æ–Ω–∏ –±–æ–ª—å—à–µ
                        const firebaseScores = data.playerScores || {};
                        const mergedScores = { ...playerScores }; // –ù–∞—á–∏–Ω–∞–µ–º —Å –ª–æ–∫–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                        
                        for (const [player, firebaseScore] of Object.entries(firebaseScores)) {
                            const localScore = playerScores[player] || 0;
                            // Firebase –∏–º–µ–µ—Ç –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç, –Ω–æ –µ—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å—á–µ—Ç –±–æ–ª—å—à–µ - –æ—Å—Ç–∞–≤–ª—è–µ–º –µ–≥–æ
                            mergedScores[player] = Math.max(localScore, firebaseScore);
                            
                            if (localScore !== firebaseScore) {
                                console.log(` [SYNC] ${player}: local=${localScore}, firebase=${firebaseScore}, final=${mergedScores[player]}`);
                            }
                        }
                        
                        playerScores = mergedScores;
                        
                        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–≥—Ä–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –≥–ª–æ–±–∞–ª—å–Ω–æ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö
                        window.gameData = data;
                        
                        updateScoreDisplay('firebase');
                        
                        // –°–Ω–∏–º–∞–µ–º —Ñ–ª–∞–≥ –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                        setTimeout(() => {
                            isUpdatingFromFirebase = false;
                        }, 500);
                    } else {
                        console.log(' [SYNC] –î–æ–∫—É–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω, —Å–æ–∑–¥–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ...');
                        // –ï—Å–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ –Ω–µ—Ç, —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
                        saveScores();
                    }
                }, (error) => {
                    console.error(' [SYNC] –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê Firebase –ø–æ–¥–ø–∏—Å–∫–∏:', error.message);
                    showFirebaseError('–ü–æ—Ç–µ—Ä—è–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Firebase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
                });
            } catch (error) {
                console.error(' [SYNC] –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ Firebase:', error.message);
                showFirebaseError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ Firebase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
            }
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ä–µ–π—Ç–∏–Ω–≥–∞
        function updateScoreDisplay(dataSource = 'offline') {
            const leaderboard = document.getElementById('leaderboard');
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º –∏–≥—Ä–æ–∫–æ–≤ –ø–æ –æ—á–∫–∞–º
            const sortedPlayers = Object.entries(playerScores)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10); // –¢–æ–ø 10
            
            if (sortedPlayers.length === 0) {
                leaderboard.innerHTML = '<div class="no-scores">No players yet</div>';
            } else {
                leaderboard.innerHTML = ''; // –û—á–∏—â–∞–µ–º
                
                sortedPlayers.forEach(([username, score], index) => {
                    const medals = ['ü•á', 'ü•à', 'ü•â'];
                    const medal = index < 3 ? medals[index] : `${index + 1}.`;
                    
                    // –°–æ–∑–¥–∞–µ–º —ç–ª–µ–º–µ–Ω—Ç –±–µ–∑–æ–ø–∞—Å–Ω–æ
                    const item = document.createElement('div');
                    item.className = 'leaderboard-item';
                    
                    // –†–∞–Ω–≥
                    const rankSpan = createSafeElement('span', 'rank', medal);
                    item.appendChild(rankSpan);
                    
                    // –ö–Ω–æ–ø–∫–∏ –¥—Ä—É–∑–µ–π/–≤—Ä–∞–≥–æ–≤
                    if (isLoggedIn && currentUser) {
                        const relationButtons = document.createElement('span');
                        relationButtons.className = 'relation-buttons';
                        
                        if (username === currentUser.username) {
                            // –î–õ–Ø –°–û–ë–°–¢–í–ï–ù–ù–û–ì–û –ù–ò–ö–ù–ï–ô–ú–ê - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—Ç–æ –¥–æ–±–∞–≤–∏–ª –≤ –¥—Ä—É–∑—å—è/–≤—Ä–∞–≥–∏
                            const { friendedBy = [], enemiedBy = [] } = window.currentUserRelationIndex || {};
                            
                            // –ö–Ω–æ–ø–∫–∞ "–∫—Ç–æ –¥–æ–±–∞–≤–∏–ª –≤ –¥—Ä—É–∑—å—è"
                            const friendBtn = document.createElement('button');
                            friendBtn.className = 'relation-btn info friend';
                            friendBtn.disabled = true; // –ù–µ–∞–∫—Ç–∏–≤–Ω–∞—è
                            friendBtn.title = friendedBy.length > 0 ? 
                                `You are friended by: ${friendedBy.join(', ')}` : 
                                'Nobody added you as friend yet';
                            friendBtn.textContent = '‚ù§Ô∏è';
                            
                            // –ö–Ω–æ–ø–∫–∞ "–∫—Ç–æ –¥–æ–±–∞–≤–∏–ª –≤–æ –≤—Ä–∞–≥–∏"
                            const enemyBtn = document.createElement('button');
                            enemyBtn.className = 'relation-btn info enemy';
                            enemyBtn.disabled = true; // –ù–µ–∞–∫—Ç–∏–≤–Ω–∞—è
                            enemyBtn.title = enemiedBy.length > 0 ? 
                                `You are enemied by: ${enemiedBy.join(', ')}` : 
                                'Nobody added you as enemy yet';
                            enemyBtn.textContent = 'üí©';
                            
                            relationButtons.appendChild(friendBtn);
                            relationButtons.appendChild(enemyBtn);
                        } else {
                            // –î–õ–Ø –î–†–£–ì–ò–• –ò–ì–†–û–ö–û–í - –æ–±—ã—á–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–∏—Ç—å/—É–±—Ä–∞—Ç—å
                            const playerRelations = window.gameData?.playerRelations?.[currentUser.username] || {};
                            const isFriend = playerRelations.friend === username;
                            const isEnemy = playerRelations.enemy === username;
                            
                            // –ö–Ω–æ–ø–∫–∞ –¥—Ä—É–≥–∞
                            const friendBtn = document.createElement('button');
                            friendBtn.className = isFriend ? 'relation-btn active friend' : 'relation-btn friend';
                            friendBtn.dataset.type = 'friend';
                            friendBtn.dataset.target = escapeHtml(username); // üîí –≠–ö–†–ê–ù–ò–†–£–ï–ú!
                            friendBtn.title = isFriend ? 'Remove from friends' : 'Add as friend';
                            friendBtn.textContent = '‚ù§Ô∏è';
                            
                            // –ö–Ω–æ–ø–∫–∞ –≤—Ä–∞–≥–∞
                            const enemyBtn = document.createElement('button');
                            enemyBtn.className = isEnemy ? 'relation-btn active enemy' : 'relation-btn enemy';
                            enemyBtn.dataset.type = 'enemy';
                            enemyBtn.dataset.target = escapeHtml(username); // üîí –≠–ö–†–ê–ù–ò–†–£–ï–ú!
                            enemyBtn.title = isEnemy ? 'Remove from enemies' : 'Add as enemy';
                            enemyBtn.textContent = 'üí©';
                            
                            relationButtons.appendChild(friendBtn);
                            relationButtons.appendChild(enemyBtn);
                        }
                        
                        item.appendChild(relationButtons);
                    }
                    
                    // Username - –ë–ï–ó–û–ü–ê–°–ù–û —á–µ—Ä–µ–∑ textContent
                    const usernameSpan = createSafeElement('span', 'username', username);
                    item.appendChild(usernameSpan);
                    
                    // Score
                    const scoreSpan = createSafeElement('span', 'score', score.toString());
                    item.appendChild(scoreSpan);
                    
                    leaderboard.appendChild(item);
                });
            }
            
            console.log(`üé® –†–µ–π—Ç–∏–Ω–≥ –æ–±–Ω–æ–≤–ª–µ–Ω (${dataSource}):`, playerScores);
        }

        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç –∏–≥—Ä–æ–∫–∞
        async function updatePlayerScore(username, points) {
            if (!username) return;
            
            if (!playerScores[username]) {
                // –ù–æ–≤—ã–π –∏–≥—Ä–æ–∫ –ø–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ä—Ç–æ–≤—ã–µ 1000 –æ—á–∫–æ–≤
                playerScores[username] = 1000;
                console.log('üéâ –ù–æ–≤—ã–π –∏–≥—Ä–æ–∫! –°—Ç–∞—Ä—Ç–æ–≤—ã–µ 1000 –æ—á–∫–æ–≤ –¥–ª—è:', username);
            }
            playerScores[username] += points;
            
            updateScoreDisplay('firebase');
            await saveScores(); // ‚úÖ –ñ–î–ï–ú —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–ª—è –∫—Ä–æ—Å—Å-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏!
            updateAuthUI(); // –æ–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        }


        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –±–æ–Ω—É—Å–∞
        function saveBonusTime(nextBonusTime) {
            try {
                localStorage.setItem('nextBonusTime', nextBonusTime.toString());
            } catch (error) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Ä–µ–º–µ–Ω–∏ —Å–ª–µ–¥—É—é—â–µ–≥–æ –±–æ–Ω—É—Å–∞
        function loadBonusTime() {
            try {
                const savedTime = localStorage.getItem('nextBonusTime');
                return savedTime ? parseInt(savedTime) : null;
            } catch (error) {
                return null;
            }
        }

        let timerInterval = null;

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–Ω—É—Å–∞
        async function claimBonus() {
            console.log('üéÅ [DEBUG] claimBonus –≤—ã–∑–≤–∞–Ω');
            
            try {
                if (!isLoggedIn || !currentUser) {
                    console.log('‚ùå [DEBUG] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                    alert('Please login to claim bonus!');
                    return;
                }

                const username = currentUser.username;
                console.log('üéÅ [DEBUG] –ù–∞—á–∏—Å–ª—è–µ–º –±–æ–Ω—É—Å –¥–ª—è:', username);

                // –î–æ–±–∞–≤–ª—è–µ–º 300 –æ—á–∫–æ–≤ —Ç–µ–∫—É—â–µ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                await updatePlayerScore(username, 300);
                console.log('‚úÖ [DEBUG] –ë–æ–Ω—É—Å +300 –æ—á–∫–æ–≤ –Ω–∞—á–∏—Å–ª–µ–Ω!');
                
                // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
                bonusButton.disabled = true;
                
                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è (30-180 —Å–µ–∫—É–Ω–¥)
                const waitTime = getRandomInt(30, 180);
                const nextBonusTime = Date.now() + (waitTime * 1000);
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –±–æ–Ω—É—Å–∞
                localStorage.setItem('nextBonusTime', nextBonusTime.toString());
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
                startBonusTimer(nextBonusTime);
                addHistoryItem('bonus', `Bonus received: +300`);
            } catch (error) {
                activateBonus(); // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–∞–π–º–µ—Ä–∞ –±–æ–Ω—É—Å–∞
        function startBonusTimer(nextBonusTime) {
            // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∏–Ω—Ç–µ—Ä–≤–∞–ª –µ—Å–ª–∏ –µ—Å—Ç—å
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }

            function updateTimer() {
                const now = Date.now();
                const timeLeft = Math.max(0, Math.ceil((nextBonusTime - now) / 1000));
                
                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    activateBonus();
                } else {
                    bonusButton.disabled = true;
                    bonusTimer.textContent = `Available in: ${formatTime(timeLeft)}`;
                }
            }
            
            // –°—Ä–∞–∑—É –æ–±–Ω–æ–≤–ª—è–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
            updateTimer();
            timerInterval = setInterval(updateTimer, 1000);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –±–æ–Ω—É—Å–Ω–æ–π –∫–Ω–æ–ø–∫–∏
        function activateBonus() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            bonusButton.disabled = false;
            bonusTimer.textContent = 'Bonus available!';
            localStorage.removeItem('nextBonusTime');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω–æ–≥–æ —á–∏—Å–ª–∞ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return `${minutes}:${remainingSeconds.toString().padStart(2, '0')}`;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firebase –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
        async function testFirebaseConnection() {
            try {
                const gameDocRef = window.firebaseDB.collection('scores').doc('game_data');
                await gameDocRef.get();
                console.log('‚úÖ Firebase –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!');
                return true;
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firebase:', error.message);
                showFirebaseError('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Firebase. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
                return false;
            }
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function initialize() {
            try {
                console.log('üöÄ –ó–∞–ø—É—Å–∫ –∏–≥—Ä—ã...');
                
                // üîê –ò–ù–ò–¶–ò–ê–õ–ò–ó–ò–†–£–ï–ú FIREBASE –ë–ï–ó–û–ü–ê–°–ù–û
                console.log('üîê –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Firebase —Å env –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏...');
                const firebaseInitialized = await initializeFirebaseSafely();
                if (!firebaseInitialized) {
                    console.error('‚ùå –ò–≥—Ä–∞ –Ω–µ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ Firebase!');
                    return; // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã URL –∏ —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                checkURLParams();
                
                // üî• –ü–†–û–í–ï–†–Ø–ï–ú –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï –ö FIREBASE
                console.log('üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Firebase...');
                const firebaseConnected = await testFirebaseConnection();
                if (!firebaseConnected) {
                    console.error('‚ùå –ò–≥—Ä–∞ –Ω–µ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ Firebase!');
                    return; // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                console.log('üîç [DEBUG] –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...');
                await checkAuthStatus();
                console.log('‚úÖ [DEBUG] –°—Ç–∞—Ç—É—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–µ–Ω');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–Ω–æ—à–µ–Ω–∏—è –¥—Ä—É–∑–µ–π/–≤—Ä–∞–≥–æ–≤ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω
                if (isLoggedIn && currentUser) {
                    console.log('üë• [DEBUG] –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–Ω–æ—à–µ–Ω–∏—è –¥—Ä—É–∑–µ–π/–≤—Ä–∞–≥–æ–≤...');
                    await loadPlayerRelations();
                    console.log('‚úÖ [DEBUG] –û—Ç–Ω–æ—à–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                    
                    console.log('üë• [DEBUG] –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –∫—Ç–æ –¥–æ–±–∞–≤–∏–ª –≤ –¥—Ä—É–∑—å—è/–≤—Ä–∞–≥–∏...');
                    window.currentUserRelationIndex = await loadWhoAddedMe();
                    console.log('‚úÖ [DEBUG] –°–ø–∏—Å–æ–∫ –∑–∞–≥—Ä—É–∂–µ–Ω:', window.currentUserRelationIndex);
                }
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞—Ä–∞–±–∞–Ω—ã
                console.log('üé∞ [DEBUG] –í—ã–∑—ã–≤–∞–µ–º initializeReels...');
                await initializeReels();
                console.log('‚úÖ [DEBUG] initializeReels –∑–∞–≤–µ—Ä—à–µ–Ω');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –æ—á–∫–∏
                console.log('üíæ [DEBUG] –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –æ—á–∫–∏...');
                await loadSavedScores();
                console.log('‚úÖ [DEBUG] –û—á–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã');
                
                // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
                console.log('üì° [DEBUG] –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è...');
                subscribeToScores();
                console.log('‚úÖ [DEBUG] –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
                console.log('üîÑ [DEBUG] –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å...');
                updateAuthUI();
                console.log('‚úÖ [DEBUG] –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –æ–±–Ω–æ–≤–ª–µ–Ω');
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Å–ø–∏–Ω–∞
                console.log('üé∞ [DEBUG] –ò—â–µ–º –∫–Ω–æ–ø–∫—É —Å–ø–∏–Ω–∞...');
                const spinButton = document.querySelector('.spin-button');
                console.log('üé∞ [DEBUG] –ö–Ω–æ–ø–∫–∞ –Ω–∞–π–¥–µ–Ω–∞:', spinButton ? '–î–ê' : '–ù–ï–¢');
                if (spinButton) {
                    spinButton.addEventListener('click', () => {
                        console.log('üé∞ [DEBUG] Event listener —Å—Ä–∞–±–æ—Ç–∞–ª!');
                        spin();
                    });
                    console.log('‚úÖ [DEBUG] Event listener –¥–æ–±–∞–≤–ª–µ–Ω');
                } else {
                    console.log('‚ùå [DEBUG] –ö–Ω–æ–ø–∫–∞ .spin-button –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
                }
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –±–æ–Ω—É—Å–∞
                bonusButton = document.getElementById('bonusButton');
                bonusTimer = document.getElementById('bonusTimer');
                
                if (bonusButton) {
                    bonusButton.addEventListener('click', async () => {
                        console.log('üí∞ [DEBUG] Bonus button clicked!');
                        
                        try {
                            if (!isLoggedIn || !currentUser) {
                                console.log('‚ùå [DEBUG] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
                                alert('Please login to claim bonus!');
                                return;
                            }

                            console.log('‚úÖ [DEBUG] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω, –Ω–∞—á–∏—Å–ª—è–µ–º –±–æ–Ω—É—Å...');
                            
                            // –ù–∞—á–∏—Å–ª—è–µ–º –±–æ–Ω—É—Å
                            await updatePlayerScore(currentUser.username, 300);
                            console.log('‚úÖ [DEBUG] –ë–æ–Ω—É—Å +300 –æ—á–∫–æ–≤ –Ω–∞—á–∏—Å–ª–µ–Ω!');
                            
                            // –û—Ç–∫–ª—é—á–∞–µ–º –∫–Ω–æ–ø–∫—É –∏ –∑–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
                            bonusButton.disabled = true;
                            
                            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω–æ–µ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è (30-180 —Å–µ–∫—É–Ω–¥)
                            const waitTime = Math.floor(Math.random() * (180 - 30 + 1)) + 30;
                            const nextBonusTime = Date.now() + waitTime * 1000;
                            
                            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ä–µ–º—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –±–æ–Ω—É—Å–∞
                            localStorage.setItem('nextBonusTime', nextBonusTime.toString());
                            
                            // –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–∞–π–º–µ—Ä
                            startBonusTimer(nextBonusTime);
                            addHistoryItem('bonus', `Bonus received: +300`);
                        } catch (error) {
                            activateBonus(); // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                        }
                    });
                    console.log('‚úÖ [DEBUG] Bonus button event listener –¥–æ–±–∞–≤–ª–µ–Ω');
                } else {
                    console.log('‚ùå [DEBUG] –ö–Ω–æ–ø–∫–∞ bonusButton –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
                }
                
                // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –¥—Ä—É–∑–µ–π/–≤—Ä–∞–≥–æ–≤
                const leaderboard = document.getElementById('leaderboard');
                if (leaderboard) {
                    leaderboard.addEventListener('click', handleRelationButtonClick);
                    leaderboard.addEventListener('mouseenter', handleEmojiHover, true);
                    leaderboard.addEventListener('mouseleave', handleEmojiHover, true);
                    console.log('‚úÖ [DEBUG] –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∫–Ω–æ–ø–æ–∫ –¥—Ä—É–∑–µ–π/–≤—Ä–∞–≥–æ–≤ –∏ tooltip –ø–æ–¥–∫–ª—é—á–µ–Ω—ã');
                }
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è –±–æ–Ω—É—Å–∞
                const savedTime = localStorage.getItem('nextBonusTime');
                if (savedTime) {
                    const nextBonusTime = parseInt(savedTime);
                    if (nextBonusTime > Date.now()) {
                        startBonusTimer(nextBonusTime);
                    } else {
                        activateBonus();
                    }
                } else {
                    activateBonus();
                }
                
                // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º –≤—ã—Å–æ—Ç—É –±–ª–æ–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Å –ø—Ä–∞–π—Å-–ª–∏—Å—Ç–æ–º
                function syncHistoryHeight() {
                    const priceList = document.querySelector('.price-list');
                    const historyContainer = document.querySelector('.history-container');
                    if (priceList && historyContainer) {
                        const styles = window.getComputedStyle(priceList);
                        const height = priceList.offsetHeight - parseInt(styles.marginBottom);
                        document.documentElement.style.setProperty('--price-list-height', height + 'px');
                    }
                }

                // –í—ã–∑—ã–≤–∞–µ–º —Å—Ä–∞–∑—É –∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
                syncHistoryHeight();
                window.addEventListener('resize', syncHistoryHeight);
            } catch (error) {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –æ—à–∏–±–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
            }
        }

        let emojiPrices = {
            'üéÆ': 15,  // Gaming (—Å–Ω–∏–∂–µ–Ω–æ —Å 25)
            'üé≤': 15,
            'üéØ': 15,
            'üé±': 15,
            'üé≥': 15,
            'üéº': 30, // Music (—Å–Ω–∏–∂–µ–Ω–æ —Å 50)
            'üéµ': 30,
            'üé∏': 30,
            'üé∫': 30,
            'üé∑': 30,
            'üéπ': 30,
            'üéª': 30,
            'üé¨': 45, // Entertainment (—Å–Ω–∏–∂–µ–Ω–æ —Å 75)
            'üé™': 45,
            'üé®': 45,
            'üé≠': 45,
            'üåü': 75, // Nature (—Å–Ω–∏–∂–µ–Ω–æ —Å 125)
            'üí´': 75,
            '‚≠ê': 75,
            'üåô': 75,
            '‚òÄÔ∏è': 75,
            'üåà': 75,
            'üçÄ': 100, // Luck (—Å–Ω–∏–∂–µ–Ω–æ —Å 150)
            'üéã': 100,
            'üéç': 100,
            'üé∞': 200 // Jackpot (—Å–Ω–∏–∂–µ–Ω–æ —Å 300)
        };

        let emojis = Object.keys(emojiPrices);
        let score = 0;

        // –°–æ–∑–¥–∞–µ–º –ø—Ä–∞–π—Å-–ª–∏—Å—Ç
        function createPriceList() {
            const priceItems = document.querySelector('.price-items');
            const sortedEmojis = [...emojis].sort((a, b) => emojiPrices[b] - emojiPrices[a]);
            
            sortedEmojis.forEach(emoji => {
                const item = document.createElement('div');
                item.className = 'price-item';
                // üîí –ë–ï–ó–û–ü–ê–°–ù–û–ï —Å–æ–∑–¥–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –±–µ–∑ innerHTML
                const emojiSpan = createSafeElement('span', 'emoji', emoji);
                const pointsSpan = createSafeElement('span', 'points', `${emojiPrices[emoji]} points`);
                item.appendChild(emojiSpan);
                item.appendChild(pointsSpan);
                priceItems.appendChild(item);
            });
        }

        function updateScore(points) {
            score += points;
            document.querySelector('.score-value').textContent = score;
        }

        function getRandomEmoji() {
            return emojis[Math.floor(Math.random() * emojis.length)];
        }

        function createReelContent() {
            return Array(15).fill(null).map(() => {
                const div = document.createElement('div');
                div.className = 'emoji-symbol';
                div.textContent = getRandomEmoji();
                return div;
            });
        }

        function initializeReels() {
            console.log('üé∞ [DEBUG] –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞—Ä–∞–±–∞–Ω—ã...');
            const reelStrips = document.querySelectorAll('.reel-strip');
            console.log('üé∞ [DEBUG] –ù–∞–π–¥–µ–Ω–æ –±–∞—Ä–∞–±–∞–Ω–æ–≤:', reelStrips.length);
            
            reelStrips.forEach((strip, index) => {
                const symbols = createReelContent();
                console.log(`üé∞ [DEBUG] –°–æ–∑–¥–∞–Ω–æ —Å–∏–º–≤–æ–ª–æ–≤ –¥–ª—è –±–∞—Ä–∞–±–∞–Ω–∞ ${index}:`, symbols.length);
                strip.innerHTML = ''; // –û—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                symbols.forEach(symbol => strip.appendChild(symbol));
                console.log(`üé∞ [DEBUG] –ë–∞—Ä–∞–±–∞–Ω ${index} –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω`);
            });
            console.log('üé∞ [DEBUG] –í—Å–µ –±–∞—Ä–∞–±–∞–Ω—ã –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω—ã');
        }

        function clearWinLines() {
            const winLines = document.getElementById('winLines');
            if (winLines) {
                winLines.innerHTML = '';
            }
        }

        function drawWinLine(x1, y1, x2, y2) {
            const winLines = document.getElementById('winLines');
            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute("x1", x1);
            line.setAttribute("y1", y1);
            line.setAttribute("x2", x2);
            line.setAttribute("y2", y2);
            line.classList.add("win-line");
            winLines.appendChild(line);
        }

        async function spin() {
            console.log('üé∞ [DEBUG] Spin clicked, isSpinning:', isSpinning);
            if (isSpinning) return;

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            if (!isLoggedIn || !currentUser) {
                alert('Please login through Orbitar to play!');
                return;
            }
            
            const username = currentUser.username;
            console.log('üé∞ [DEBUG] Current username:', username);

            const currentScore = playerScores[username] || 0;
            console.log('üé∞ [DEBUG] Current score:', currentScore);

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –æ—á–∫–æ–≤ –¥–ª—è —Å–ø–∏–Ω–∞ (100 –æ—á–∫–æ–≤)
            if (currentScore < 100) {
                alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –æ—á–∫–æ–≤ –¥–ª—è —Å–ø–∏–Ω–∞! –£ –≤–∞—Å ${currentScore} –æ—á–∫–æ–≤, –Ω—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 100.`);
                return;
            }

            // –°–ø–∏—Å—ã–≤–∞–µ–º 100 –æ—á–∫–æ–≤
            await updatePlayerScore(username, -100);

            // –°–†–ê–ó–£ –∑–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–∫–ª–∏–∫–∞
            isSpinning = true;
            clearWinLines();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ (saveScores —É–∂–µ –≤—ã–∑–≤–∞–Ω –≤ updatePlayerScore —Å await)
            updateScoreDisplay();
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–∞—Ä–∞–±–∞–Ω–∞
            const newReelContents = Array(3).fill(null).map(() => createReelContent());
            const reelStrips = document.querySelectorAll('.reel-strip');
            const button = document.querySelector('.spin-button');
            if (button) button.disabled = true;
            
            reelStrips.forEach((strip, index) => {
                // –û—á–∏—â–∞–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ —Å–∏–º–≤–æ–ª—ã
                strip.innerHTML = '';
                newReelContents[index].forEach(symbol => strip.appendChild(symbol));
                
                // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
                strip.classList.add('spinning');
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –±–∞—Ä–∞–±–∞–Ω —á–µ—Ä–µ–∑ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è
                setTimeout(() => {
                    strip.classList.remove('spinning');
                    // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É —Å–∏–º–≤–æ–ª–∞ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                    const symbolHeight = strip.children[0] ? parseInt(getComputedStyle(strip.children[0]).height) : 60;
                    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—É—é –ø–æ–∑–∏—Ü–∏—é –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (0, 1 –∏–ª–∏ 2 —Å–∏–º–≤–æ–ª–∞)
                    const stopPosition = Math.floor(Math.random() * 3) * symbolHeight;
                    strip.style.transform = `translateY(-${stopPosition}px)`;
                    
                    // –ï—Å–ª–∏ —ç—Ç–æ –ø–æ—Å–ª–µ–¥–Ω–∏–π –±–∞—Ä–∞–±–∞–Ω
                    if (index === 2) {
                        setTimeout(() => {
                            isSpinning = false;
                            button.disabled = false;
                            checkWinningLines();
                        }, 500);
                    }
                }, 2000 + index * 700); // –ö–∞–∂–¥—ã–π —Å–ª–µ–¥—É—é—â–∏–π –±–∞—Ä–∞–±–∞–Ω –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
            });
        }

        async function checkWinningLines() {
            const reelStrips = document.querySelectorAll('.reel-strip');
            const symbols = Array.from(reelStrips).map(strip => {
                const visibleSymbols = [];
                // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—É—é –≤—ã—Å–æ—Ç—É —Å–∏–º–≤–æ–ª–∞ –∏–∑ –ø–µ—Ä–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞
                const symbolHeight = strip.children[0] ? parseInt(getComputedStyle(strip.children[0]).height) : 60;
                const offset = Math.abs(parseInt(strip.style.transform?.match(/-?\d+/)?.[0] || '0')) / symbolHeight;
                for(let i = 0; i < 3; i++) {
                    const symbol = strip.children[i + Math.floor(offset)];
                    if(symbol) {
                        visibleSymbols.push(symbol.textContent);
                    }
                }
                return visibleSymbols;
            });

            let winnings = 0;

            // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç —Ü–µ–Ω—Ç—Ä–∞ —Å–∏–º–≤–æ–ª–∞ –∏–∑ DOM
            function getSymbolCenter(col, row) {
                const reelStrips = document.querySelectorAll('.reel-strip');
                if (!reelStrips[col]) return { x: 0, y: 0 };
                
                const strip = reelStrips[col];
                const offset = Math.abs(parseInt(strip.style.transform?.match(/-?\d+/)?.[0] || '0')) / 
                              parseInt(getComputedStyle(strip.children[0]).height);
                
                const symbolIndex = Math.floor(offset) + row;
                const symbol = strip.children[symbolIndex];
                
                if (!symbol) return { x: 0, y: 0 };
                
                // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ .reels
                const reelsContainer = document.querySelector('.reels');
                const reelsRect = reelsContainer.getBoundingClientRect();
                const symbolRect = symbol.getBoundingClientRect();
                
                // –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–Ω—Ç—Ä–∞ —Å–∏–º–≤–æ–ª–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ SVG canvas (–∫–æ—Ç–æ—Ä—ã–π –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –æ—Ç .reels)
                const x = symbolRect.left - reelsRect.left + symbolRect.width / 2 + 18; // —Å–º–µ—â–µ–Ω–∏–µ –Ω–∞ 18px –ø—Ä–∞–≤–µ–µ
                const y = symbolRect.top - reelsRect.top + symbolRect.height / 2 - 8; // —Å–º–µ—â–µ–Ω–∏–µ –Ω–∞ 8px –≤—ã—à–µ
                
                return { x, y };
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
            for(let row = 0; row < 3; row++) {
                if(symbols[0][row] === symbols[1][row] && symbols[1][row] === symbols[2][row]) {
                    const start = getSymbolCenter(0, row);
                    const end = getSymbolCenter(2, row);
                    drawWinLine(start.x, start.y, end.x, end.y);
                    winnings += emojiPrices[symbols[0][row]] * 3;
                } else {
                    if(symbols[0][row] === symbols[1][row]) {
                        const start = getSymbolCenter(0, row);
                        const end = getSymbolCenter(1, row);
                        drawWinLine(start.x, start.y, end.x, end.y);
                        winnings += emojiPrices[symbols[0][row]] * 2;
                    }
                    if(symbols[1][row] === symbols[2][row]) {
                        const start = getSymbolCenter(1, row);
                        const end = getSymbolCenter(2, row);
                        drawWinLine(start.x, start.y, end.x, end.y);
                        winnings += emojiPrices[symbols[1][row]] * 2;
                    }
                }
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
            for(let col = 0; col < 3; col++) {
                if(symbols[col][0] === symbols[col][1] && symbols[col][1] === symbols[col][2]) {
                    const start = getSymbolCenter(col, 0);
                    const end = getSymbolCenter(col, 2);
                    drawWinLine(start.x, start.y, end.x, end.y);
                    winnings += emojiPrices[symbols[col][0]] * 3;
                } else {
                    if(symbols[col][0] === symbols[col][1]) {
                        const start = getSymbolCenter(col, 0);
                        const end = getSymbolCenter(col, 1);
                        drawWinLine(start.x, start.y, end.x, end.y);
                        winnings += emojiPrices[symbols[col][0]] * 2;
                    }
                    if(symbols[col][1] === symbols[col][2]) {
                        const start = getSymbolCenter(col, 1);
                        const end = getSymbolCenter(col, 2);
                        drawWinLine(start.x, start.y, end.x, end.y);
                        winnings += emojiPrices[symbols[col][1]] * 2;
                    }
                }
            }

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∏–∞–≥–æ–Ω–∞–ª—å–Ω—ã–µ –ª–∏–Ω–∏–∏
            // –ì–ª–∞–≤–Ω–∞—è –¥–∏–∞–≥–æ–Ω–∞–ª—å (—Å–≤–µ—Ä—Ö—É —Å–ª–µ–≤–∞ –≤–Ω–∏–∑ –Ω–∞–ø—Ä–∞–≤–æ)
            if(symbols[0][0] === symbols[1][1] && symbols[1][1] === symbols[2][2]) {
                const start = getSymbolCenter(0, 0);
                const end = getSymbolCenter(2, 2);
                drawWinLine(start.x, start.y, end.x, end.y);
                winnings += emojiPrices[symbols[0][0]] * 3;
            } else {
                if(symbols[0][0] === symbols[1][1]) {
                    const start = getSymbolCenter(0, 0);
                    const end = getSymbolCenter(1, 1);
                    drawWinLine(start.x, start.y, end.x, end.y);
                    winnings += emojiPrices[symbols[0][0]] * 2;
                }
                if(symbols[1][1] === symbols[2][2]) {
                    const start = getSymbolCenter(1, 1);
                    const end = getSymbolCenter(2, 2);
                    drawWinLine(start.x, start.y, end.x, end.y);
                    winnings += emojiPrices[symbols[1][1]] * 2;
                }
            }

            // –û–±—Ä–∞—Ç–Ω–∞—è –¥–∏–∞–≥–æ–Ω–∞–ª—å (—Å–Ω–∏–∑—É —Å–ª–µ–≤–∞ –≤–≤–µ—Ä—Ö –Ω–∞–ø—Ä–∞–≤–æ)
            if(symbols[0][2] === symbols[1][1] && symbols[1][1] === symbols[2][0]) {
                const start = getSymbolCenter(0, 2);
                const end = getSymbolCenter(2, 0);
                drawWinLine(start.x, start.y, end.x, end.y);
                winnings += emojiPrices[symbols[0][2]] * 3;
            } else {
                if(symbols[0][2] === symbols[1][1]) {
                    const start = getSymbolCenter(0, 2);
                    const end = getSymbolCenter(1, 1);
                    drawWinLine(start.x, start.y, end.x, end.y);
                    winnings += emojiPrices[symbols[0][2]] * 2;
                }
                if(symbols[1][1] === symbols[2][0]) {
                    const start = getSymbolCenter(1, 1);
                    const end = getSymbolCenter(2, 0);
                    drawWinLine(start.x, start.y, end.x, end.y);
                    winnings += emojiPrices[symbols[1][1]] * 2;
                }
            }

            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ—Ä–æ—Ç–∫–∏–µ –¥–∏–∞–≥–æ–Ω–∞–ª–∏
            // –°–≤–µ—Ä—Ö—É —Å–ª–µ–≤–∞ –≤–Ω–∏–∑ –Ω–∞–ø—Ä–∞–≤–æ
            if(symbols[0][1] === symbols[1][2]) {
                const start = getSymbolCenter(0, 1);
                const end = getSymbolCenter(1, 2);
                drawWinLine(start.x, start.y, end.x, end.y);
                winnings += emojiPrices[symbols[0][1]] * 2;
            }
            if(symbols[1][0] === symbols[2][1]) {
                const start = getSymbolCenter(1, 0);
                const end = getSymbolCenter(2, 1);
                drawWinLine(start.x, start.y, end.x, end.y);
                winnings += emojiPrices[symbols[1][0]] * 2;
            }

            // –°–Ω–∏–∑—É —Å–ª–µ–≤–∞ –≤–≤–µ—Ä—Ö –Ω–∞–ø—Ä–∞–≤–æ
            if(symbols[0][1] === symbols[1][0]) {
                const start = getSymbolCenter(0, 1);
                const end = getSymbolCenter(1, 0);
                drawWinLine(start.x, start.y, end.x, end.y);
                winnings += emojiPrices[symbols[0][1]] * 2;
            }
            if(symbols[1][2] === symbols[2][1]) {
                const start = getSymbolCenter(1, 2);
                const end = getSymbolCenter(2, 1);
                drawWinLine(start.x, start.y, end.x, end.y);
                winnings += emojiPrices[symbols[1][2]] * 2;
            }

            if(winnings > 0) {
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—á–∫–æ–≤
                const username = getCurrentUsername();
                await updatePlayerScore(username, winnings);
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á–∏—Å—Ç—ã–π –≤—ã–∏–≥—Ä—ã—à (–∑–∞ –≤—ã—á–µ—Ç–æ–º —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Å–ø–∏–Ω–∞)
                const netWin = winnings - 100;
                
                if (netWin > 0) {
                    // –¢–æ–ª—å–∫–æ –ø—Ä–∏ —Ä–µ–∞–ª—å–Ω–æ–º –≤—ã–∏–≥—Ä—ã—à–µ –Ω–∞—á–∏—Å–ª—è–µ–º/—Å–ø–∏—Å—ã–≤–∞–µ–º –±–æ–Ω—É—Å—ã –¥—Ä—É–∑—å—è–º/–≤—Ä–∞–≥–∞–º
                    // –ü–µ—Ä–µ–¥–∞–µ–º —á–∏—Å—Ç—ã–π –≤—ã–∏–≥—Ä—ã—à, –∞ –Ω–µ –ø–æ–ª–Ω—ã–π
                    const bonusResult = await processFriendEnemyBonuses(username, netWin);
                    
                    let message = `Win: +${netWin}`;
                    if (bonusResult.friendBonus) {
                        message += ` (‚ù§Ô∏è+${bonusResult.friendBonus.amount} to ${bonusResult.friendBonus.name})`;
                    }
                    if (bonusResult.enemyPenalty) {
                        message += ` (üí©-${bonusResult.enemyPenalty.amount} from ${bonusResult.enemyPenalty.name})`;
                    }
                    
                    addHistoryItem('win', message);
                } else if (netWin === 0) {
                    addHistoryItem('loss', `Break even: 0`);
                } else {
                    addHistoryItem('loss', `Lost spin: ${netWin}`);
                }
            } else {
                addHistoryItem('loss', `Lost spin: -100`);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ç–µ–º—ã
        function toggleTheme() {
            const body = document.body;
            const themeSwitch = document.querySelector('.theme-switch');
            const themeIcon = themeSwitch.querySelector('.theme-icon');
            const themeText = themeSwitch.querySelector('.theme-text');
            
            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                themeIcon.textContent = '‚òÄÔ∏è';
                themeText.textContent = 'Light';
            } else {
                body.setAttribute('data-theme', 'dark');
                themeIcon.textContent = 'üåô';
                themeText.textContent = 'Dark';
            }
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—ã–±–æ—Ä —Ç–µ–º—ã
            localStorage.setItem('theme', body.getAttribute('data-theme') || 'light');
        }

        // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ç–µ–º—É –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                document.querySelector('.theme-icon').textContent = 'üåô';
                document.querySelector('.theme-text').textContent = 'Dark';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–æ–≤ –ø–æ –∫–Ω–æ–ø–∫–∞–º –¥—Ä—É–∑–µ–π/–≤—Ä–∞–≥–æ–≤
        async function handleRelationButtonClick(event) {
            if (!event.target.classList.contains('relation-btn')) return;
            
            const button = event.target;
            const type = button.dataset.type; // 'friend' –∏–ª–∏ 'enemy'
            const target = button.dataset.target; // –Ω–∏–∫–Ω–µ–π–º
            
            // –ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–ª—è—Ç—å —Å–µ–±—è –≤ –¥—Ä—É–∑—å—è/–≤—Ä–∞–≥–∏
            if (currentUser && target === currentUser.username) {
                console.log('‚ùå –ù–µ–ª—å–∑—è –¥–æ–±–∞–≤–ª—è—Ç—å —Å–µ–±—è –≤ –¥—Ä—É–∑—å—è/–≤—Ä–∞–≥–∏');
                return;
            }
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
            button.disabled = true;
            
            try {
                console.log(`üîÑ –ö–ª–∏–∫ –ø–æ –∫–Ω–æ–ø–∫–µ: ${type} –¥–ª—è ${target}`);
                
                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
                const isActive = button.classList.contains('active');
                const action = isActive ? 'remove' : 'add';
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                await savePlayerRelation(target, type, action);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ API –≤—ã–∑–æ–≤–∞
                if (action === 'add') {
                    playerRelations[type] = target;
                    // –†–∞–∑—Ä–µ—à–∞–µ–º –∏–º–µ—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∏ –¥—Ä—É–≥–∞, –∏ –≤—Ä–∞–≥–∞
                    // –£–±—Ä–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω—É–ª–µ–Ω–∏–µ –ø—Ä–æ—Ç–∏–≤–æ–ø–æ–ª–æ–∂–Ω–æ–≥–æ –æ—Ç–Ω–æ—à–µ–Ω–∏—è
                    console.log(`‚ûï –î–æ–±–∞–≤–∏–ª–∏ ${target} –≤ ${type === 'friend' ? '–¥—Ä—É–∑—å—è' : '–≤—Ä–∞–≥–∏'} (—Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ Firebase)`);
                } else {
                    playerRelations[type] = null;
                    console.log(`‚ûñ –£–±—Ä–∞–ª–∏ ${target} –∏–∑ ${type === 'friend' ? '–¥—Ä—É–∑–µ–π' : '–≤—Ä–∞–≥–æ–≤'} (—É–¥–∞–ª–µ–Ω–æ –∏–∑ Firebase)`);
                }
                
                // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ tooltip –ø–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–Ω–æ—à–µ–Ω–∏–π
                if (currentUser) {
                    window.currentUserRelationIndex = await loadWhoAddedMe();
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–∞–±–ª–∏—Ü—ã –ª–∏–¥–µ—Ä–æ–≤
                updateScoreDisplay();
                
            } catch (error) {
                console.log('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –æ—Ç–Ω–æ—à–µ–Ω–∏—è:', error);
                // –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                addHistoryItem('loss', `Error: Failed to update ${type} status`);
            } finally {
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É
                button.disabled = false;
            }
        }

        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å tooltip
        function showTooltip(element, content) {
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.textContent = content;
            element.appendChild(tooltip);
        }

        function hideTooltip(element) {
            const tooltip = element.querySelector('.tooltip');
            if (tooltip) {
                tooltip.remove();
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–≤–µ–¥–µ–Ω–∏—è –Ω–∞ —ç–º–æ–¥–∂–∏ —É —Å–≤–æ–µ–≥–æ –Ω–∏–∫–∞
        function handleEmojiHover(event) {
            if (!event.target.classList.contains('user-emoji')) return;
            
            const emoji = event.target;
            const type = emoji.dataset.tooltip;
            
            if (event.type === 'mouseenter') {
                let tooltipText = '';
                if (type === 'friend') {
                    const friends = emoji.dataset.friends || '';
                    tooltipText = friends ? `Friends: ${friends}` : 'No friends yet';
                } else if (type === 'enemy') {
                    const enemies = emoji.dataset.enemies || '';
                    tooltipText = enemies ? `Enemies: ${enemies}` : 'No enemies yet';
                }
                showTooltip(emoji, tooltipText);
            } else if (event.type === 'mouseleave') {
                hideTooltip(emoji);
            }
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
        initialize();
    </script>
</body>
</html>